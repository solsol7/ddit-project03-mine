<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.company.dao.TestDAO">

<sql id="searchFlag">
	<trim prefix="where" prefixOverrides="AND">
		<if test="@org.apache.commons.lang3.StringUtils@isNotBlank(detailCondition.companyId)">
			AND COMPANY_ID=#{detailCondition.companyId}
		</if>
		<if test='@org.apache.commons.lang3.StringUtils@isNotBlank(detailCondition.testType)'>
			AND TEST_TYPE=#{detailCondition.testType}
		</if>
		<if test='@org.apache.commons.lang3.StringUtils@isNotBlank(detailCondition.testTitle)'>
			AND INSTR(TEST_TITLE,#{detailCondition.testTitle})>0
		</if>
		<if test="@org.apache.commons.lang3.StringUtils@isNotBlank(variousCondition.sDate)">
			<![CDATA[
			AND TEST_DATE >= #{variousCondition.sDate}
			]]>
		</if>
		<if test="@org.apache.commons.lang3.StringUtils@isNotBlank(variousCondition.eDate)">
			<![CDATA[
			AND TEST_DATE <= #{variousCondition.eDate}
			]]>
		</if>
	</trim>
</sql>


<select id="selectTotalRecord" parameterType="string" resultType="int">
	SELECT COUNT(*) FROM TEST WHERE TEST_TYPE=#{testType}
</select>

<select id="selectTestList" parameterType="PaginationInfo" resultType="TestVO">
	SELECT B.*
	FROM (
	    SELECT ROWNUM RNUM, A.*
	    FROM (
	        SELECT 
	            TEST_NO, COMPANY_ID
	            , TEST_TITLE, TEST_TYPE, TEST_DATE
	        FROM TEST
	        <include refid="searchFlag" />
	        ORDER BY TEST_DATE DESC
	    ) A
	) B 
	<![CDATA[
	WHERE RNUM>=#{startRow} AND RNUM<=#{endRow}
	]]>
</select>


<resultMap type="TestVO" id="testDetailMap" autoMapping="true">
	<id property="testNo" column="TEST_NO" />
	<collection property="qstnList" ofType="TestQstnVO" autoMapping="true">
		<id property="qstnNo" column="QSTN_NO"/>
		<collection property="itemList" ofType="TestItemVO" autoMapping="true"/>
	</collection>
</resultMap>
<select id="selectTestDetail" resultMap="testDetailMap" parameterType="string">
	SELECT
		TEST_NO, TEST_TITLE
		, QSTN_NO, QSTN_CONT, QSTN_ANSWER
		, ITEM_NO, ITEM_CONT
	FROM V_TESTDETAIL
	WHERE TEST_NO=#{testNo}
	ORDER BY QSTN_NO, ITEM_NO
</select>

<insert id="insertTest" parameterType="TestVO">
	<selectKey keyProperty="testNo" order="BEFORE" resultType="string">
		select 'T'||LPAD(test_seq.nextval,6,'0') from dual
	</selectKey>
	INSERT INTO test (
	    test_no
	    , company_id
	    , test_title
	    , test_type
	    , test_date
	) VALUES (
	    #{testNo,jdbcType=VARCHAR}
		, #{companyId,jdbcType=VARCHAR}
		, #{testTitle,jdbcType=VARCHAR}
		, #{testType,jdbcType=VARCHAR}
		, sysdate
	)
</insert>

<insert id="insertTestQstn" parameterType="TestQstnVO">
	INSERT INTO test_qstn (
	    test_no
	    , qstn_no
	    , qstn_cont
	    , qstn_answer
	) VALUES (
		#{testNo,jdbcType=VARCHAR}
		, #{qstnNo,jdbcType=NUMERIC}
		, #{qstnCont,jdbcType=VARCHAR}
		, #{qstnAnswer,jdbcType=VARCHAR}
	)
</insert>

<insert id="insertTestItem" parameterType="TestItemVO">
	INSERT INTO test_item (
	    test_no
	    , qstn_no
	    , item_no
	    , item_cont
	) VALUES (
		#{testNo,jdbcType=VARCHAR}
		, #{qstnNo,jdbcType=NUMERIC}
		, #{itemNo,jdbcType=NUMERIC}
		, #{itemCont,jdbcType=VARCHAR}
	)
</insert>

<delete id="deleteTest" parameterType="string">
	DELETE FROM test
	WHERE
        TEST_NO = #{testNo}
</delete>

<delete id="deleteTestQstn" parameterType="string">
	DELETE FROM test_qstn
	WHERE
        TEST_NO = #{testNo}
</delete>

<delete id="deleteTestItem" parameterType="string">
	DELETE FROM test_item
	WHERE
        TEST_NO = #{testNo}
</delete>

</mapper>